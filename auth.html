<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth Bridge</title>
  <!-- Firebase JS SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Thunkable WebViewer 확장 -->
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
<script>
  // 1) Firebase 초기화: 콘솔에서 복사한 값으로 교체
  const firebaseConfig = {
    apiKey: "YOUR_WEB_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // 공통: Thunkable로 메시지 보내기
  const send = (obj) =>
    ThunkableWebviewerExtension.postMessage(JSON.stringify(obj));

  // 웹뷰 로드 완료 알림 (버튼 활성화 시그널로 사용)
  window.addEventListener('load', () => send({type:'ready'}));

  // 로그인 상태 변화도 알려주면 편함
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      const idToken = await user.getIdToken(/*forceRefresh=*/false);
      send({type:'auth_state', signedIn:true, uid:user.uid, idToken});
    } else {
      send({type:'auth_state', signedIn:false});
    }
  });

  // 2) Thunkable → 웹뷰 메시지 수신 처리
  ThunkableWebviewerExtension.receiveMessage(async (raw) => {
    try {
      const msg = JSON.parse(raw);

      if (msg.type === 'signup') {
        const cred = await auth.createUserWithEmailAndPassword(msg.email, msg.password);
        const idToken = await cred.user.getIdToken();
        send({ok:true, mode:'signup', uid:cred.user.uid, idToken});
      }

      if (msg.type === 'login') {
        const cred = await auth.signInWithEmailAndPassword(msg.email, msg.password);
        const idToken = await cred.user.getIdToken();
        send({ok:true, mode:'login', uid:cred.user.uid, idToken});
      }

      if (msg.type === 'reset') {
        await auth.sendPasswordResetEmail(msg.email);
        send({ok:true, mode:'reset'});
      }

      if (msg.type === 'signout') {
        await auth.signOut();
        send({ok:true, mode:'signout'});
      }

      if (msg.type === 'refresh') {
        // 토큰 재발급
        const user = auth.currentUser;
        if (!user) return send({ok:false, error:'not_signed_in'});
        const idToken = await user.getIdToken(true);
        send({ok:true, mode:'refresh', uid:user.uid, idToken});
      }

    } catch (e) {
      send({ok:false, error: e && e.message ? e.message : String(e)});
    }
  });
</script>
</body>
</html>
